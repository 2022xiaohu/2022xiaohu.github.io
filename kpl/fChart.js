var fChart_=function(){var a={};a.initChart={};a.switchChart=function(t){var r;if(!t)r=$("#cft-menu>.atv");else r=$(t);var e=r.attr("data-ct");if(t&&r.hasClass("atv"))return;r.addClass("atv").siblings(".atv").removeClass("atv");$('#cft-chartBox>.cft-cb[data-ct="'+e+'"]').addClass("atv").siblings(".atv").removeClass("atv");if(!a.initChart[e]){a.initChart[e]=true;if(e=="min"){a.reqFMChartData(a.sid)}else{a.reqFKChartData(a.sid,true)}}};a.reqFMChartData=function(t){var r=$("#floatMChart");r.html($_.GetLoadTip("loading",{va:true}));var e;var i;if(t.indexOf("8")==0){i="plate";e={c:"PCArrangeData",a:"GetZSHQPlate",SelType:1,PStockID:t,PlateID:t}}else{i="stock";e={c:"StockL2Data",a:"GetStockTrend",StockID:t}}$_.ajax({url:$_.reqUrl4,data:e,suc:function(t){$_.GetLoadTip("loading",{va:true,box:r});var e=i=="plate"?t.trend:t;if(!e){e={preclose_px:0,hprice:0,lprice:0,trend:[]}}var o={yp:parseFloat(e.preclose_px),date:function(){var a=[];if(e.day){a.push(e.day.substr(0,4));a.push(e.day.substr(4,2));a.push(e.day.substr(6))}return a.join("-")}(),list:e.trend};a.mChart=new floatMChart(r,{data:o,stockType:i,hasAvg:i=="plate"?false:true})},berro:function(a){r.append($_.GetLoadTip("reload",{va:true,box:r,tip:a.errmsg,attr:"onclick=\"fChart_.reqFMChartData('"+t+"')\""}))},err:function(){r.append($_.GetLoadTip("reload",{va:true,box:r,attr:"onclick=\"fChart_.reqFMChartData('"+t+"')\""}))}})};a.reqFKChartData=function(t,r){var e=$("#floatKChart");var i=a.kChart;if(!i||r){r=true;e.append($_.GetLoadTip("loading",{va:true,box:e}))}var o=1;var n={x:[],k:[],vol:{l:[],e:[]}};var d=1e3;var l=function(){o--;if(o>0)return;if(r)$_.GetLoadTip("loading",{va:true,box:e});if(!i){a.kChart=new floatKChart_(e,{data:n,kType:"d",showZoomBtn:true})}else{i.setData(n);i.DrawOverall("redraw")}};var c=function(a){if(i||!r)return;var o={va:true,tip:a.errmsg,attr:"onclick=\"fChart_.reqFKChartData('"+t+"')\"",box:e};if(a)o.tip=a.errmsg;e.append($_.GetLoadTip("reload",o))};(function(){var a,r;var e;if(t.indexOf("8")==0){e="plate";r=$_.reqUrl5;a={c:"ZhiShuKLine",a:"GetPlateKLineDay",StockID:t,Index:0,st:d,Type:"d"}}else{e="stock";r=$_.reqUrl5;a={c:"StockLineData",a:"GetKLineDay",StockID:t,Index:0,st:d}}$_.ajax({url:r,data:a,suc:function(a){(function(){var t=a.y.length;(function(){a.m5=[];a.m10=[];a.m20=[];a.m30=[]})();for(var r=0;r<t;r++){var e=a.y[r];var i=NaN,o=NaN,n=NaN,d=NaN,l=0;var c=[],s=NaN;var f=[];var u=function(){var a=30;return r-a}();for(var h=r;h>u;h--){var v=a.y[h];if(h<0||!v)break;l+=v[1];if(h==r-4)i=l;if(h==r-9)o=l;if(h==r-19)n=l;if(h==r-29)d=l}a.m5.push(i/5);a.m10.push(o/10);a.m20.push(n/20);a.m30.push(d/30)}})();n.x=a.x;n.k=a.y;n.vol={l:a.vol,e:a.bal};n.m5=a.m5;n.m10=a.m10;n.m20=a.m20;n.m30=a.m30;l()},berro:function(a){c(a)},err:function(){c()}})})()};a.reqSFMChartData=function(t,r){var e=$("#floatMChart_s");e.html($_.GetLoadTip("loading",{va:true}));var i={c:"StockL2Data",a:"GetStockTrend",StockID:t};$_.ajax({url:$_.reqUrl4,data:i,suc:function(i){$_.GetLoadTip("loading",{va:true,box:e});var o=i;if(!o){o={preclose_px:0,hprice:0,lprice:0,trend:[]}}var n={yp:parseFloat(o.preclose_px),hp:parseFloat(o.hprice),lp:parseFloat(o.lprice),date:function(){var a=[];if(o.day){a.push(o.day.substr(0,4));a.push(o.day.substr(4,2));a.push(o.day.substr(6))}return a.join("-")}(),name:r,code:t,list:o.trend};a.mChart=new floatMChart_small(e,{data:n})},berro:function(a){e.append($_.GetLoadTip("reload",{va:true,box:e,tip:a.errmsg,attr:"onclick=\"fChart_.reqSFMChartData('"+t+"')\""}))},err:function(){e.append($_.GetLoadTip("reload",{va:true,box:e,attr:"onclick=\"fChart_.reqSFMChartData('"+t+"')\""}))}})};a.reqIsAddUSto=function(){var t=$("#cfloat-win .cft-head>.addBon");t.attr("data-fb",1);t.append($_.GetLoadTip("loading",{va:true,tip:"",box:t}));Data={c:"PCArrangeData",a:"GetHQPlate",StockID:a.sid,SelType:7};$_.ajax({url:$_.reqUrl4,data:Data,suc:function(a){if(a.selval==0){t.attr("data-hasadd",0).attr("data-fb",0).html("添加自选").attr("onclick","fChart_.addDelUSto(this,'add')")}else{t.attr("data-hasadd",1).attr("data-fb",0).html("删除自选").attr("onclick","fChart_.addDelUSto(this,'del')")}},berro:function(a){t.append($_.GetLoadTip("reload",{va:true,box:t,tip:"",attr:'onclick="fChart_.reqIsAddUSto()"'}))},err:function(a){t.append($_.GetLoadTip("reload",{va:true,box:t,tip:"",attr:'onclick="fChart_.reqIsAddUSto()"'}))}})};a.addDelUSto=function(t,r){var e=$(t);e.append($_.GetLoadTip("loading",{va:true,tip:"",box:e}));var i={succ:function(){if(r=="del"){e.attr("data-hasadd",0).attr("data-fb",0).html("添加自选").attr("onclick","fChart_.addDelUSto(this,'add')")}else{e.attr("data-hasadd",1).attr("data-fb",0).html("删除自选").attr("onclick","fChart_.addDelUSto(this,'del')")}},berro:function(){$_.GetLoadTip("loading",{va:true,tip:"",box:e})},err:function(){$_.GetLoadTip("loading",{va:true,tip:"",box:e})}};if(window.ustock_){ustock_.ustockOption(r,a.sid,i)}else{$_.ajax({url:$_.reqUrl+(r=="add"?"/api/user/addstock":"/api/user/delstock"),data:{code:a.sid},suc:i.succ,berro:i.berro,err:i.err})}};a.initStu=function(){var a='<div class="cfloat-win" id="cfloat-win">'+'    <div class="cft-body">'+'        <div class="arowbar rightAB"><div></div></div>'+'        <div class="cft-head">'+'            <div class="sname">股票名称</div>'+'            <ul id="cft-menu">'+'                <li data-ct="min" class="atv" onclick="fChart_.switchChart(this)">分时</li>'+'                <li data-ct="d" onclick="fChart_.switchChart(this)">日K</li>'+"            </ul>"+'            <div class="addBon" data-fb="1">添加自选</div>'+"        </div>"+'        <div class="cft-box" id="cft-chartBox">'+'            <div data-ct="min" class="cft-cb atv">'+'                <div id="floatMChart"></div>'+"            </div>"+'            <div data-ct="d" class="cft-cb">'+'                <div id="floatKChart"></div>'+"            </div>"+"        </div>"+"    </div>"+"</div>";$("#cfloat-win").remove();$("body").append(a)};return a}();$(function(){fChart_.initStu()});$(document).on("mouseenter",".over-chart[data-ct]",function(a){var t=$(this),r=t.attr("data-ct"),e;if(r=="big"){e=$("#cfloat-win")}else if(r=="small"){e=$("#cfloat-win-sm")}else{return}e.hide();window.clearTimeout(fChart_.OVC_st);window.clearTimeout(fChart_.OVC_st2);var i=t.attr("data-name"),o=t.attr("data-sid");if(!o)return;(function(){var o=t.width(),n=t.height(),d=$(window),l=d.width(),c=d.height(),s=0,f=0,u=d.scrollTop(),h=d.scrollLeft();(function(){var a=t[0];while(a){var r=$(a);s+=r.scrollTop();f+=r.scrollLeft();a=a.parentNode}s-=u*2;f-=h*2});var v,p,C,m,_;(function(){if(r=="big"){v=15;p=24;C=460;m=280;_=60}else if(r=="small"){v=15;p=24;C=280;m=145;_=60}})();var b=a.clientX-a.offsetX,w=a.clientY-a.offsetY;var k=C+v;var x=w+n/2,D=b,g=b+o;var T=D,S=l-g;var G,L,y;(function(){if(S>=T){G="right";L=g+v}else{G="left";L=D-v-C}if(c>=m){y=x-_;var a=c-m,t=10;if(a<t*2)t=a/2;if(y<t)y=t;else if(y>c-m-t)y=c-m-t}else{y=0}var r=p/2+4;if(y>x-r)y=x-r;else if(y+m<x+r)y=x+r-m;var o=e.find(".arowbar");if(G=="left")o.addClass("rightAB");else o.removeClass("rightAB");o.children("div").css({"margin-top":x-y-p/2+"px"});e.css({top:y+"px",left:L+"px"});e.find(".sname").html(i)})()})();fChart_.OVC_st=setTimeout(function(){e.show();(function(){if(r=="big"){fChart_.sid=o;fChart_.initChart={};fChart_.switchChart();fChart_.reqIsAddUSto()}else if(r=="small"){fChart_.reqSFMChartData(o,i)}})()},350)}).on("mouseleave",".over-chart",function(){fChart_.OVC_st2=setTimeout(function(){window.clearTimeout(fChart_.OVC_st);$("#cfloat-win,#cfloat-win-sm").hide()},50)});$(document).on("mouseover","#cfloat-win,#cfloat-win-sm",function(){window.clearTimeout(fChart_.OVC_st2)}).on("mouseleave","#cfloat-win,#cfloat-win-sm",function(){$(this).hide()});$("body").on("mousewheel","#floatKChart",function(a){return;var t=fChart_.kChart;if(!t)return;var r=a.originalEvent.wheelDelta;if(r>0){t.GetComParam("large");t.DrawOverall("large")}else if(r<0){t.GetComParam("small");t.DrawOverall("small")}return false});